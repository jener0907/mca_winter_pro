#include <WiFi.h>
#include <AsyncTCP.h>
#include <ESPAsyncWebServer.h>

// üìå Wi-Fi AP Î™®Îìú ÏÑ§Ï†ï
const char* apSSID = "SOJU_Dispenser";
const char* apPassword = "12345678";

// üìå Ïõπ ÏÑúÎ≤Ñ Í∞ùÏ≤¥ ÏÉùÏÑ±
AsyncWebServer server(80);

// üìå Î™®ÌÑ∞ ÎìúÎùºÏù¥Î≤Ñ ÌïÄ ÏÑ§Ï†ï
#define MOTOR_IN1 14  
#define MOTOR_IN2 15  

bool isMotorRunning = false;  // ‚úÖ Î™®ÌÑ∞ Ïã§Ìñâ Ïó¨Î∂Ä
bool isContinuousMode = false; // ‚úÖ Ïó∞ÏÜç Ï∂îÏ∂ú Î™®Îìú Ïó¨Î∂Ä

// üìå Î™®ÌÑ∞ Ïã§Ìñâ Task (ÎπÑÎèôÍ∏∞ Î∞©ÏãùÏúºÎ°ú Ïã§Ìñâ)
void motorTask(void *pvParameters) {
    int duration = *(int*)pvParameters;
    delete (int*)pvParameters; // ‚úÖ ÎèôÏ†Å Ìï†Îãπ Ìï¥Ï†ú

    isMotorRunning = true;
    Serial.println("üöÄ Î™®ÌÑ∞ ÏãúÏûë...");
    digitalWrite(MOTOR_IN1, HIGH);
    digitalWrite(MOTOR_IN2, LOW);

    vTaskDelay(duration / portTICK_PERIOD_MS); // ‚úÖ ÎπÑÎèôÍ∏∞ ÎåÄÍ∏∞ (Watchdog Î≥¥Ìò∏)

    digitalWrite(MOTOR_IN1, LOW);
    digitalWrite(MOTOR_IN2, LOW);
    Serial.println("üõë Î™®ÌÑ∞ Ï†ïÏßÄ.");

    isMotorRunning = false;
    vTaskDelete(NULL); // ‚úÖ Task Ï¢ÖÎ£å
}

// üìå Î™®ÌÑ∞ ÏûëÎèô Ìï®Ïàò (RTOS Task Í∏∞Î∞ò ÎπÑÎèôÍ∏∞ Ïã§Ìñâ)
void startMotor(int duration) {
    if (isMotorRunning || isContinuousMode) return;
    xTaskCreatePinnedToCore(motorTask, "MotorTask", 2048, new int(duration), 1, NULL, 1);
}

// üìå Ïó∞ÏÜç Ï∂îÏ∂ú Î™®Îìú Ïã§Ìñâ (Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ Í≥ÑÏÜç ÏûëÎèô)
void startContinuousMotor() {
    if (isMotorRunning) return;
    isMotorRunning = true;
    isContinuousMode = true;

    Serial.println("üöÄ Ïó∞ÏÜç Ï∂îÏ∂ú ÏãúÏûë...");
    digitalWrite(MOTOR_IN1, HIGH);
    digitalWrite(MOTOR_IN2, LOW);
}

// üìå Ï†ïÏßÄ Î≤ÑÌäº ‚Üí Î™®Îì† ÎèôÏûë Í∞ïÏ†ú Ï†ïÏßÄ
void stopAllMotors() {
    Serial.println("üõë Î™®Îì† ÎèôÏûë Ï§ëÏßÄ.");
    digitalWrite(MOTOR_IN1, LOW);
    digitalWrite(MOTOR_IN2, LOW);
    isMotorRunning = false;
    isContinuousMode = false;
}

void setup() {
    Serial.begin(115200);

    pinMode(MOTOR_IN1, OUTPUT);
    pinMode(MOTOR_IN2, OUTPUT);
    digitalWrite(MOTOR_IN1, LOW);
    digitalWrite(MOTOR_IN2, LOW);

    WiFi.mode(WIFI_AP);
    WiFi.softAP(apSSID, apPassword);
    WiFi.setSleep(false);  // Ï†àÏ†Ñ Î™®Îìú Ìï¥Ï†ú
    
    Serial.print("üåç AP Mode IP: ");
    Serial.println(WiFi.softAPIP());

    // üìå HTTP GET ÏöîÏ≤≠ÏùÑ ÌÜµÌïú Î™®ÌÑ∞ Ï†úÏñ¥
    server.on("/motor", HTTP_GET, [](AsyncWebServerRequest *request) {
        if (request->hasParam("cup")) {
            String cupSize = request->getParam("cup")->value();
            Serial.print("üì© Î∞õÏùÄ ÏöîÏ≤≠: ");
            Serial.println(cupSize);

            if (cupSize == "A") startMotor(3000);
            else if (cupSize == "B") startMotor(4000);
            else if (cupSize == "C") startMotor(4900);
            else if (cupSize == "D") startContinuousMotor();
            else if (cupSize == "STOP") stopAllMotors();
        }
        request->send(200, "text/plain", "OK");
    });


    // üìå Ïõπ UI Ï†úÍ≥µ (setup() ÎÇ¥Î∂ÄÎ°ú Ïù¥Îèô)
    server.on("/", HTTP_GET, [](AsyncWebServerRequest *request) {
        request->send_P(200, "text/html; charset=UTF-8", R"rawliteral(
            <!DOCTYPE html>
            <html lang="ko">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
                <meta name="theme-color" content="#f5f6fa">
                <title>MCA ÏÜåÏ£º ÎîîÏä§ÌéúÏÑú</title>
                <style>
                    :root {
                        --primary-color: #00a8ff;
                        --secondary-color: #273c75;
                        --accent-color: #e84118;
                        --light-color: #f5f6fa;
                        --dark-color: #2f3640;
                        --random-color: #9b59b6;
                        --background-gradient: linear-gradient(135deg, #f5f6fa, #dcdde1);
                    }
                    
                    /* Î∞∞Í≤ΩÏÉâ Î™ÖÏãúÏ†Å ÏßÄÏ†ï */
                    html, body {
                        background-color: var(--light-color);
                        background: var(--background-gradient);
                        margin: 0;
                        padding: 0;
                        min-height: 100vh;
                        width: 100%;
                    }
                    
                    body {
                        font-family: 'Helvetica Neue', Arial, sans-serif;
                        color: var(--dark-color);
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                    }
                    
                    .page-wrapper {
                        background-color: var(--light-color);
                        background: var(--background-gradient);
                        min-height: 100vh;
                        width: 100%;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        padding: 20px 0;
                        box-sizing: border-box;
                    }
                    
                    .container {
                        max-width: 500px;
                        width: 90%;
                        background-color: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
                        padding: 25px;
                        margin: 20px 0;
                    }
                    
                    h1 {
                        color: var(--secondary-color);
                        text-align: center;
                        margin-bottom: 5px;
                        font-size: 2.2rem;
                    }
                    
                    .subtitle {
                        color: var(--dark-color);
                        text-align: center;
                        margin-top: 0;
                        margin-bottom: 25px;
                        font-size: 1rem;
                        opacity: 0.7;
                    }
                    
                    .status-container {
                        background-color: var(--light-color);
                        border-radius: 8px;
                        padding: 12px;
                        margin: 15px 0;
                        text-align: center;
                    }
                    
                    .status {
                        font-size: 1.2rem;
                        font-weight: bold;
                        color: var(--secondary-color);
                        margin: 0;
                    }
                    
                    .btn-container {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 15px;
                        margin-top: 20px;
                    }
                    
                    .btn {
                        font-size: 1.1rem;
                        padding: 15px 10px;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-weight: bold;
                        text-align: center;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .btn-small {
                        background-color: #ff7979;
                        color: white;
                    }
                    
                    .btn-medium {
                        background-color: #f0932b;
                        color: white;
                    }
                    
                    .btn-large {
                        background-color: #eb4d4b;
                        color: white;
                    }
                    
                    .btn-random {
                        background-color: var(--random-color);
                        color: white;
                    }
                    
                    .btn-extra {
                        background-color: var(--primary-color);
                        color: white;
                        grid-column: span 2;
                    }
                    
                    .btn-stop {
                        background-color: var(--dark-color);
                        color: white;
                        grid-column: span 2;
                    }
                    
                    .btn:hover:not(.disabled) {
                        transform: translateY(-3px);
                        box-shadow: 0 5px 10px rgba(0,0,0,0.2);
                    }
                    
                    .btn .emoji {
                        font-size: 1.8rem;
                        margin-bottom: 5px;
                    }
                    
                    .disabled {
                        opacity: 0.5;
                        cursor: not-allowed !important;
                        transform: none !important;
                        box-shadow: none !important;
                        pointer-events: none;
                    }
                    
                    /* Î™®Î∞îÏùº ÌäπÏ†ï Ïä§ÌÉÄÏùº */
                    @media (max-width: 400px) {
                        .btn-container {
                            grid-template-columns: 1fr;
                        }
                        
                        .btn-extra, .btn-stop {
                            grid-column: auto;
                        }
                        
                        html, body, .page-wrapper {
                            background-color: var(--light-color) !important;
                            background: var(--background-gradient) !important;
                        }
                    }
                    
                    /* Îã§ÌÅ¨ Î™®Îìú ÎåÄÏùë */
                    @media (prefers-color-scheme: dark) {
                        html, body, .page-wrapper {
                            background-color: var(--light-color) !important;
                            background: var(--background-gradient) !important;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="page-wrapper">
                    <div class="container">
                        <h1>MCA ÏÜåÏ£º ÎîîÏä§ÌéúÏÑú</h1>
                        <p class="subtitle">ÏõêÌïòÎäî ÏñëÎßåÌÅº ÏÜåÏ£ºÎ•º Îî∞Î•¥ÏÑ∏Ïöî</p>
                        
                        <div class="status-container">
                            <p class="status" id="statusText">üü¢ Ï§ÄÎπÑ ÏôÑÎ£å</p>
                        </div>
                        
                        <div class="btn-container">
                            <button id="btnSmall" class="btn btn-small" onclick="handleButtonClick('A', 'Î∞òÏûî Îî∞Î•¥Îäî Ï§ë...')">
                                <span class="emoji">ü•É</span>
                                <span>Î∞òÏûî</span>
                            </button>
                            <button id="btnMedium" class="btn btn-medium" onclick="handleButtonClick('B', 'ÌïúÏûî Îî∞Î•¥Îäî Ï§ë...')">
                                <span class="emoji">üç∂</span>
                                <span>ÌïúÏûî</span>
                            </button>
                            <button id="btnLarge" class="btn btn-large" onclick="handleButtonClick('C', 'ÌíÄÏûî Îî∞Î•¥Îäî Ï§ë...')">
                                <span class="emoji">üçæ</span>
                                <span>ÌíÄÏûî</span>
                            </button>
                            <button id="btnRandom" class="btn btn-random" onclick="handleRandomClick()">
                                <span class="emoji">üé≤</span>
                                <span>ÎûúÎç§</span>
                            </button>
                            <button id="btnContinuous" class="btn btn-extra" onclick="handleContinuousClick()">
                                <span class="emoji">üîÑ</span>
                                <span>Ïó∞ÏÜç Ï∂îÏ∂ú</span>
                            </button>
                            <button id="btnStop" class="btn btn-stop" onclick="handleStopClick()">
                                <span class="emoji">‚õî</span>
                                <span>Ï†ïÏßÄ</span>
                            </button>
                        </div>
                    </div>
                </div>

                <script>
                    // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÏûëÏóÖ ÏÉÅÌÉú Í¥ÄÎ¶¨
                    let isWorking = false;
                    
                    // Î≤ÑÌäº ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ - Î™®Îì† ÌÅ¥Î¶≠ÏùÄ Ïù¥ Ìï®ÏàòÎì§ÏùÑ ÌÜµÌï¥ Ï≤òÎ¶¨
                    function handleButtonClick(cup, text) {
                        if (isWorking) return; // Ïù¥ÎØ∏ ÏûëÎèô Ï§ëÏù¥Î©¥ Î¨¥Ïãú
                        
                        isWorking = true;
                        disableAllButtons(true);
                        document.getElementById("statusText").innerText = "üî¥ " + text;
                        
                        // ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
                        var xhr = new XMLHttpRequest();
                        xhr.open("GET", "/motor?cup=" + cup, true);
                        xhr.send();
                        
                        // ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï (ÏûëÏóÖ ÏãúÍ∞ÑÏóê Îî∞Îùº Ï°∞Ï†ï)
                        let duration = 0;
                        if (cup === 'A') duration = 3000;      // Î∞òÏûî
                        else if (cup === 'B') duration = 4000; // ÌïúÏûî
                        else if (cup === 'C') duration = 4900; // ÌíÄÏûî
                        
                        setTimeout(() => {
                            document.getElementById("statusText").innerText = "üü¢ Ï§ÄÎπÑ ÏôÑÎ£å";
                            disableAllButtons(false);
                            isWorking = false;
                        }, duration);
                    }
                    
                    function handleRandomClick() {
                        if (isWorking) return; // Ïù¥ÎØ∏ ÏûëÎèô Ï§ëÏù¥Î©¥ Î¨¥Ïãú
                        
                        // ÎûúÎç§ÏúºÎ°ú A(Î∞òÏûî), B(ÌïúÏûî), C(ÌíÄÏûî) Ï§ë ÌïòÎÇò ÏÑ†ÌÉù
                        const options = ['A', 'B', 'C'];
                        const texts = ['Î∞òÏûî Îî∞Î•¥Îäî Ï§ë...', 'ÌïúÏûî Îî∞Î•¥Îäî Ï§ë...', 'ÌíÄÏûî Îî∞Î•¥Îäî Ï§ë...'];
                        const durations = [3000, 4000, 4900];
                        
                        // 0-2 ÏÇ¨Ïù¥Ïùò ÎûúÎç§ Ïù∏Îç±Ïä§ ÏÉùÏÑ±
                        const randomIndex = Math.floor(Math.random() * 3);
                        const selectedOption = options[randomIndex];
                        const selectedText = texts[randomIndex];
                        const selectedDuration = durations[randomIndex];
                        
                        isWorking = true;
                        disableAllButtons(true);
                        document.getElementById("statusText").innerText = "üî¥ ÎûúÎç§: " + selectedText;
                        
                        // ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
                        var xhr = new XMLHttpRequest();
                        xhr.open("GET", "/motor?cup=" + selectedOption, true);
                        xhr.send();
                        
                        setTimeout(() => {
                            document.getElementById("statusText").innerText = "üü¢ Ï§ÄÎπÑ ÏôÑÎ£å";
                            disableAllButtons(false);
                            isWorking = false;
                        }, selectedDuration);
                    }
                    
                    function handleContinuousClick() {
                        if (isWorking) return; // Ïù¥ÎØ∏ ÏûëÎèô Ï§ëÏù¥Î©¥ Î¨¥Ïãú
                        
                        isWorking = true;
                        disableAllButtons(true);
                        // Ï†ïÏßÄ Î≤ÑÌäºÏùÄ ÌôúÏÑ±Ìôî ÏÉÅÌÉúÎ°ú Ïú†ÏßÄ
                        document.getElementById("btnStop").classList.remove("disabled");
                        document.getElementById("statusText").innerText = "üî¥ Ïó∞ÏÜç Ï∂îÏ∂ú Ï§ë...";
                        
                        // ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
                        var xhr = new XMLHttpRequest();
                        xhr.open("GET", "/motor?cup=D", true);
                        xhr.send();
                        
                        // Ïó∞ÏÜç Î™®ÎìúÏóêÏÑúÎäî ÌÉÄÏù¥Î®∏Î•º ÏÑ§Ï†ïÌïòÏßÄ ÏïäÏùå (Ï†ïÏßÄ Î≤ÑÌäºÏúºÎ°úÎßå Ï§ëÎã®)
                    }
                    
                    function handleStopClick() {
                        document.getElementById("statusText").innerText = "üü¢ Ï§ÄÎπÑ ÏôÑÎ£å";
                        disableAllButtons(false);
                        isWorking = false;
                        
                        // ÏÑúÎ≤ÑÏóê Ï†ïÏßÄ ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
                        var xhr = new XMLHttpRequest();
                        xhr.open("GET", "/motor?cup=STOP", true);
                        xhr.send();
                    }
                    
                    // Î™®Îì† Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî/ÌôúÏÑ±Ìôî Ìï®Ïàò
                    function disableAllButtons(disable) {
                        const buttons = document.querySelectorAll(".btn");
                        buttons.forEach(btn => {
                            if (disable) {
                                // Ï†ïÏßÄ Î≤ÑÌäºÏùÄ Ìï≠ÏÉÅ ÌôúÏÑ± ÏÉÅÌÉú Ïú†ÏßÄ
                                if (!btn.classList.contains("btn-stop")) {
                                    btn.classList.add("disabled");
                                }
                            } else {
                                btn.classList.remove("disabled");
                            }
                        });
                    }
                </script>
            </body>
            </html>
        )rawliteral");
    });

    server.begin();
}

void loop() {
    vTaskDelay(10 / portTICK_PERIOD_MS);
}
